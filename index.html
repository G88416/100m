```html
<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCC CMMS Dashboard - Enhanced Edition</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles for better aesthetics and dark mode */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            transition: background-color 0.3s ease;
        }
        .dark body {
            background-color: #1f2937;
            color: #f3f4f6;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
        }
        .dark .card {
            background-color: #374151;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .card:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .dark .card:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        .scroll-area {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        /* Custom scrollbar */
        .scroll-area::-webkit-scrollbar { width: 8px; }
        .scroll-area::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .scroll-area::-webkit-scrollbar-track { background: #f1f5f9; }
        .dark .scroll-area::-webkit-scrollbar-thumb { background: #4b5563; }
        .dark .scroll-area::-webkit-scrollbar-track { background: #1f2937; }
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        /* Search Input */
        .search-input { transition: border-color 0.3s, box-shadow 0.3s; }
        .search-input:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
    </style>
</head>
<body class="p-4 md:p-8 transition-colors duration-300">
    
    <!-- Tailwind JIT Fix: Explicitly include classes used dynamically -->
    <div class="hidden">
        <span class="border-indigo-500 text-indigo-400"></span>
        <span class="border-red-500 text-red-400"></span>
        <span class="border-green-500 text-green-400"></span>
    </div>

    <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center">
        <div>
            <h1 class="text-4xl font-extrabold text-indigo-700 dark:text-indigo-300 mb-2">BCC CMMS Dashboard - Super Special Edition</h1>
            <p class="text-gray-500 dark:text-gray-400">Manage assets, streamline maintenance, and visualize operations across departments with enhanced features.</p>
            <p class="mt-4 text-sm text-gray-600 dark:text-gray-300 p-2 bg-indigo-100 dark:bg-indigo-900 rounded-lg">
                User ID (for collaboration): <span id="user-id-display" class="font-mono font-semibold text-indigo-800 dark:text-indigo-200">Authenticating...</span>
            </p>
        </div>
        <!-- Dark Mode Toggle -->
        <button id="dark-mode-toggle" class="mt-4 md:mt-0 py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
            <i data-lucide="moon" class="w-5 h-5 inline-block mr-1"></i> Toggle Dark Mode
        </button>
    </header>
    
    <!-- Notification Area -->
    <div id="notification-area" class="fixed top-4 right-4 z-50 space-y-2">
        <!-- Notifications will appear here -->
    </div>

    <!-- Department Filter and Search -->
    <div class="mb-8 p-4 bg-white dark:bg-gray-800 rounded-xl shadow-lg flex flex-col md:flex-row items-start md:items-center space-y-3 md:space-y-0 md:space-x-4">
        <label for="department-filter" class="font-semibold text-gray-700 dark:text-gray-300 flex items-center">
            <i data-lucide="building-2" class="w-5 h-5 mr-2 text-indigo-500 dark:text-indigo-400"></i>
            Filter by Department:
        </label>
        <select id="department-filter" onchange="changeDepartment(this.value)" class="flex-grow max-w-sm border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-gray-200">
            <!-- Options filled by JS -->
        </select>
        <!-- Global Search -->
        <input type="text" id="global-search" placeholder="Search assets or work orders..." class="mt-3 md:mt-0 md:ml-4 flex-grow max-w-sm border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-gray-200 search-input" oninput="handleGlobalSearch(this.value)">
    </div>
    
    <!-- Enhanced Stats Row with Charts -->
    <div id="stats-row" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Stats will be dynamically inserted here by JS -->
    </div>
    <!-- Visualization Chart Section -->
    <section class="card p-6 mb-8">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4 flex items-center">
            <i data-lucide="bar-chart-2" class="w-6 h-6 mr-2 text-indigo-500 dark:text-indigo-400"></i>
            Maintenance Overview Chart
        </h2>
        <canvas id="maintenance-chart" class="w-full h-64"></canvas>
    </section>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- WORK ORDERS Section -->
        <section class="lg:col-span-2 card p-6">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4 flex items-center">
                <i data-lucide="wrench" class="w-6 h-6 mr-2 text-indigo-500 dark:text-indigo-400"></i>
                Active Work Orders
            </h2>
            <div id="work-orders-list" class="scroll-area divide-y divide-gray-100 dark:divide-gray-700">
                <!-- Work Orders will be dynamically inserted here -->
                <p class="p-4 text-gray-500 dark:text-gray-400 text-center" id="wo-placeholder">Loading work orders...</p>
            </div>

            <!-- New Work Order Form -->
            <button onclick="toggleModal('new-wo-modal')" class="mt-6 w-full py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150">
                <i data-lucide="plus" class="w-5 h-5 inline-block mr-1"></i>
                Create New Work Order
            </button>
        </section>

        <!-- ASSETS Section -->
        <section class="card p-6">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4 flex items-center">
                <i data-lucide="hard-hat" class="w-6 h-6 mr-2 text-indigo-500 dark:text-indigo-400"></i>
                Registered Assets
            </h2>
            <div id="assets-list" class="scroll-area divide-y divide-gray-100 dark:divide-gray-700">
                <!-- Assets will be dynamically inserted here -->
                <p class="p-4 text-gray-500 dark:text-gray-400 text-center" id="asset-placeholder">Loading assets...</p>
            </div>

            <!-- New Asset Form -->
            <button onclick="toggleModal('new-asset-modal')" class="mt-6 w-full py-2 px-4 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150">
                <i data-lucide="factory" class="w-5 h-5 inline-block mr-1"></i>
                Add New Asset
            </button>
        </section>
    </main>

    <!-- Modal for New Work Order -->
    <div id="new-wo-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl w-full max-w-lg card">
            <h3 class="text-xl font-bold mb-4 dark:text-gray-200">Create Work Order</h3>
            <form id="new-wo-form" onsubmit="handleNewWorkOrder(event)">
                <div class="mb-4">
                    <label for="wo-department" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Department</label>
                    <select id="wo-department" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-gray-200">
                        <!-- Options filled by JS -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="wo-title" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Title</label>
                    <input type="text" id="wo-title" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-gray-200">
                </div>
                <div class="mb-4">
                    <label for="wo-asset" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Related Asset</label>
                    <select id="wo-asset" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-gray-200">
                        <option value="">Select an Asset</option>
                        <!-- Options filled by JS, filtered by selected department -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="wo-priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Priority</label>
                    <select id="wo-priority" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-gray-200">
                        <option value="High">High</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="wo-description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description (New Feature)</label>
                    <textarea id="wo-description" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-gray-200" rows="3"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="toggleModal('new-wo-modal')" class="py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">Cancel</button>
                    <button type="submit" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">Create Work Order</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for New Asset -->
    <div id="new-asset-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl w-full max-w-lg card">
            <h3 class="text-xl font-bold mb-4 dark:text-gray-200">Register New Asset</h3>
            <form id="new-asset-form" onsubmit="handleNewAsset(event)">
                <div class="mb-4">
                    <label for="asset-department" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Department</label>
                    <select id="asset-department" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:text-gray-200">
                        <!-- Options filled by JS -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="asset-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Asset Name</label>
                    <input type="text" id="asset-name" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:text-gray-200">
                </div>
                <div class="mb-4">
                    <label for="asset-location" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Location</label>
                    <input type="text" id="asset-location" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:text-gray-200">
                </div>
                <div class="mb-4">
                    <label for="asset-serial" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Serial/Model</label>
                    <input type="text" id="asset-serial" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:text-gray-200">
                </div>
                <div class="mb-4">
                    <label for="asset-description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description (New Feature)</label>
                    <textarea id="asset-description" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:text-gray-200" rows="3"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="toggleModal('new-asset-modal')" class="py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">Cancel</button>
                    <button type="submit" class="py-2 px-4 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">Register Asset</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Work Order Modal (New Feature) -->
    <div id="edit-wo-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl w-full max-w-lg card">
            <h3 class="text-xl font-bold mb-4 dark:text-gray-200">Edit Work Order</h3>
            <form id="edit-wo-form" onsubmit="handleEditWorkOrder(event)">
                <input type="hidden" id="edit-wo-id">
                <div class="mb-4">
                    <label for="edit-wo-title" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Title</label>
                    <input type="text" id="edit-wo-title" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-gray-200">
                </div>
                <div class="mb-4">
                    <label for="edit-wo-priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Priority</label>
                    <select id="edit-wo-priority" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-gray-200">
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="edit-wo-description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                    <textarea id="edit-wo-description" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-gray-200" rows="3"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="toggleModal('edit-wo-modal')" class="py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">Cancel</button>
                    <button type="submit" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-cmms-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Base path for public, collaborative data
        const BASE_PUBLIC_PATH = `/artifacts/${appId}/public/data`;
        const ASSETS_COLLECTION_PATH = `${BASE_PUBLIC_PATH}/cmms_assets`;
        const WO_COLLECTION_PATH = `${BASE_PUBLIC_PATH}/cmms_work_orders`;

        // Departments list for BCC
        const DEPARTMENTS = [
            { id: 'all', name: 'All Departments' },
            { id: 'orphanage', name: '1) Orphanage' },
            { id: 'old_age', name: '2) Old Age Home' },
            { id: 'mental_home', name: '3) Mental Home' },
            { id: 'hospice', name: '4) Hospice' },
            { id: 'bci_school', name: '5) BCI School' }
        ];

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Use a global variable to store state and references
        window.appState = {
            db: db,
            auth: auth,
            userId: null,
            allAssets: [], 
            allWorkOrders: [],
            currentDepartment: 'all',
            searchQuery: '',
            departments: DEPARTMENTS,
            chart: null // For Chart.js instance
        };

        // Set log level to Debug for visibility in console
        setLogLevel('debug');

        /* --- UTILITY FUNCTIONS --- */

        /**
         * Shows a transient notification message with animation.
         * @param {string} message The message to display.
         * @param {string} type 'success', 'error', or 'info'.
         */
        const showNotification = (message, type = 'info') => {
            const notificationArea = document.getElementById('notification-area');
            let colorClass, icon;

            switch (type) {
                case 'success':
                    colorClass = 'bg-green-500 border-green-700';
                    icon = 'check-circle';
                    break;
                case 'error':
                    colorClass = 'bg-red-500 border-red-700';
                    icon = 'alert-triangle';
                    break;
                case 'info':
                default:
                    colorClass = 'bg-blue-500 border-blue-700';
                    icon = 'info';
                    break;
            }

            const notification = document.createElement('div');
            notification.className = `p-4 rounded-lg shadow-xl text-white border-b-4 ${colorClass} transition duration-500 transform translate-x-full fade-in`;
            notification.innerHTML = `<div class="flex items-center">
                <i data-lucide="${icon}" class="w-5 h-5 mr-2"></i>
                <span>${message}</span>
            </div>`;
            
            notificationArea.appendChild(notification);
            lucide.createIcons(); // Re-render icon

            // Animate in
            setTimeout(() => notification.classList.remove('translate-x-full'), 100);

            // Automatically remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('opacity-0');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 5000);
        };

        window.toggleModal = (id, data = null) => {
            const modal = document.getElementById(id);
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                // Populate edit modal if applicable
                if (id === 'edit-wo-modal' && data) {
                    document.getElementById('edit-wo-id').value = data.id;
                    document.getElementById('edit-wo-title').value = data.title;
                    document.getElementById('edit-wo-priority').value = data.priority;
                    document.getElementById('edit-wo-description').value = data.description || '';
                }

                // Set department in creation modals
                const currentDept = window.appState.currentDepartment;
                if (currentDept !== 'all') {
                    if (id === 'new-wo-modal') {
                        const deptEl = document.getElementById('wo-department');
                        if (deptEl) deptEl.value = currentDept;
                    }
                    if (id === 'new-asset-modal') {
                        const deptEl = document.getElementById('asset-department');
                        if (deptEl) deptEl.value = currentDept;
                    }
                }
                updateWorkOrderModalAssets();
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        };

        const formatTimestamp = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        };

        const getStatusBadge = (status) => {
            switch (status) {
                case 'Open': return `<span class="status-badge bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-200">Open</span>`;
                case 'In Progress': return `<span class="status-badge bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-200">In Progress</span>`;
                case 'Completed': return `<span class="status-badge bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-200">Completed</span>`;
                default: return `<span class="status-badge bg-gray-100 text-gray-700 dark:bg-gray-900 dark:text-gray-200">${status}</span>`;
            }
        };

        /* --- DATA FILTERING & RENDERING --- */
        
        // Render summary stats
        const renderSummaryStats = () => {
            const statsRowEl = document.getElementById('stats-row');
            if (!statsRowEl) return;

            const filteredAssets = window.appState.allAssets.filter(asset => 
                (window.appState.currentDepartment === 'all' || asset.department === window.appState.currentDepartment) &&
                (asset.name.toLowerCase().includes(window.appState.searchQuery) || asset.location.toLowerCase().includes(window.appState.searchQuery))
            );
            
            const filteredWOs = window.appState.allWorkOrders.filter(wo => 
                (window.appState.currentDepartment === 'all' || wo.department === window.appState.currentDepartment) &&
                (wo.title.toLowerCase().includes(window.appState.searchQuery) || (wo.description || '').toLowerCase().includes(window.appState.searchQuery))
            );
            
            const activeWOs = filteredWOs.filter(wo => wo.status !== 'Completed');
            const completedWOs = filteredWOs.filter(wo => wo.status === 'Completed');

            const stats = [
                { title: "Total Assets", count: filteredAssets.length, icon: "hard-hat", color: "indigo" },
                { title: "Active Work Orders", count: activeWOs.length, icon: "wrench", color: "red" },
                { title: "Completed (Lifetime)", count: completedWOs.length, icon: "check-circle", color: "green" },
            ];

            statsRowEl.innerHTML = stats.map(stat => `
                <div class="card p-5 border-l-4 border-${stat.color}-500 flex items-center justify-between dark:border-${stat.color}-400">
                    <div>
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">${stat.title}</p>
                        <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">${stat.count}</p>
                    </div>
                    <i data-lucide="${stat.icon}" class="w-8 h-8 text-${stat.color}-400"></i>
                </div>
            `).join('');
            
            lucide.createIcons();
        };

        // Render Chart
        const renderChart = () => {
            const ctx = document.getElementById('maintenance-chart').getContext('2d');
            const filteredWOs = window.appState.allWorkOrders.filter(wo => 
                window.appState.currentDepartment === 'all' || wo.department === window.appState.currentDepartment
            );

            const priorities = { High: 0, Medium: 0, Low: 0 };
            const statuses = { Open: 0, 'In Progress': 0, Completed: 0 };

            filteredWOs.forEach(wo => {
                priorities[wo.priority]++;
                statuses[wo.status]++;
            });

            if (window.appState.chart) window.appState.chart.destroy();

            window.appState.chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['High Priority', 'Medium Priority', 'Low Priority', 'Open', 'In Progress', 'Completed'],
                    datasets: [{
                        data: [priorities.High, priorities.Medium, priorities.Low, statuses.Open, statuses['In Progress'], statuses.Completed],
                        backgroundColor: ['#ef4444', '#f59e0b', '#22c55e', '#ef4444', '#f59e0b', '#22c55e'],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } }
                }
            });
        };

        // Render assets
        const renderAssets = () => {
            const listEl = document.getElementById('assets-list');
            listEl.innerHTML = '';
            
            const filteredAssets = window.appState.allAssets.filter(asset => 
                (window.appState.currentDepartment === 'all' || asset.department === window.appState.currentDepartment) &&
                (asset.name.toLowerCase().includes(window.appState.searchQuery) || asset.location.toLowerCase().includes(window.appState.searchQuery) || (asset.description || '').toLowerCase().includes(window.appState.searchQuery))
            ).sort((a, b) => a.name.localeCompare(b.name));

            if (filteredAssets.length === 0) {
                listEl.innerHTML = `<p class="p-4 text-gray-500 dark:text-gray-400 text-center">No assets found.</p>`;
                return;
            }

            filteredAssets.forEach(asset => {
                const departmentName = DEPARTMENTS.find(d => d.id === asset.department)?.name || 'Unknown';
                const item = document.createElement('div');
                item.className = 'p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center hover:bg-gray-50 dark:hover:bg-gray-700';
                item.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800 dark:text-gray-200">${asset.name}</p>
                        <p class="text-xs text-indigo-500 dark:text-indigo-400 font-medium">${departmentName}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Location: ${asset.location}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${asset.description || 'No description'}</p>
                    </div>
                    <div class="mt-2 sm:mt-0 text-right">
                        <p class="text-xs text-gray-400 dark:text-gray-500">Asset ID: ${asset.id.substring(0, 8)}...</p>
                    </div>
                `;
                listEl.appendChild(item);
            });
        };

        // Render work orders
        const renderWorkOrders = () => {
            const listEl = document.getElementById('work-orders-list');
            listEl.innerHTML = '';
            
            const filteredWO = window.appState.allWorkOrders.filter(wo => 
                (window.appState.currentDepartment === 'all' || wo.department === window.appState.currentDepartment) &&
                (wo.title.toLowerCase().includes(window.appState.searchQuery) || (wo.description || '').toLowerCase().includes(window.appState.searchQuery))
            );
            
            const activeWO = filteredWO
                .filter(wo => wo.status !== 'Completed')
                .sort((a, b) => {
                    const priorityOrder = { 'High': 3, 'Medium': 2, 'Low': 1 };
                    return priorityOrder[b.priority] - priorityOrder[a.priority];
                });

            if (activeWO.length === 0) {
                listEl.innerHTML = '<p class="p-4 text-gray-500 dark:text-gray-400 text-center">No active work orders found.</p>';
                return;
            }

            activeWO.forEach(wo => {
                const relatedAsset = window.appState.allAssets.find(a => a.id === wo.assetId);
                const assetName = relatedAsset ? relatedAsset.name : 'Asset Not Found';

                const item = document.createElement('div');
                item.className = 'p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center hover:bg-gray-50 dark:hover:bg-gray-700';
                item.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800 dark:text-gray-200 flex items-center">
                            ${wo.title} 
                            <span class="ml-3 text-xs font-medium ${wo.priority === 'High' ? 'text-red-600 dark:text-red-400' : wo.priority === 'Medium' ? 'text-yellow-600 dark:text-yellow-400' : 'text-green-600 dark:text-green-400'}">(${wo.priority})</span>
                        </p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Asset: ${assetName}</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">${wo.description || 'No description'}</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500">Created: ${formatTimestamp(wo.createdAt)}</p>
                    </div>
                    <div class="mt-2 sm:mt-0 flex items-center space-x-2">
                        ${getStatusBadge(wo.status)}
                        ${wo.status !== 'Completed' ? 
                            `<button onclick="updateWorkOrderStatus('${wo.id}', '${wo.status === 'Open' ? 'In Progress' : 'Completed'}')" 
                                class="py-1 px-3 text-xs rounded-full 
                                ${wo.status === 'Open' ? 'bg-yellow-500 hover:bg-yellow-600 text-white' : 'bg-green-500 hover:bg-green-600 text-white'} 
                                transition duration-150">
                                ${wo.status === 'Open' ? 'Start' : 'Complete'}
                            </button>` : ''
                        }
                        <button onclick="toggleModal('edit-wo-modal', {id: '${wo.id}', title: '${wo.title}', priority: '${wo.priority}', description: '${wo.description || ''}'})" 
                            class="py-1 px-3 text-xs rounded-full bg-blue-500 hover:bg-blue-600 text-white transition duration-150">
                            Edit
                        </button>
                    </div>
                `;
                listEl.appendChild(item);
            });
        };
        
        const updateWorkOrderModalAssets = () => {
            const selectEl = document.getElementById('wo-asset');
            const deptToFilter = document.getElementById('wo-department')?.value || window.appState.currentDepartment;
            
            selectEl.innerHTML = '<option value="" disabled selected>Select an Asset</option>';

            const assetsForDropdown = window.appState.allAssets.filter(asset => 
                deptToFilter === 'all' || asset.department === deptToFilter
            );
            
            if (assetsForDropdown.length === 0) {
                selectEl.innerHTML += `<option value="" disabled>No Assets in this Department</option>`;
            } else {
                assetsForDropdown.forEach(asset => {
                    const option = document.createElement('option');
                    option.value = asset.id;
                    option.textContent = `${asset.name} (${asset.location})`;
                    selectEl.appendChild(option);
                });
            }
        };

        window.changeDepartment = (newDeptId) => {
            window.appState.currentDepartment = newDeptId;
            renderAssets();
            renderWorkOrders();
            renderSummaryStats();
            renderChart();
        };
        
        window.handleGlobalSearch = (query) => {
            window.appState.searchQuery = query.toLowerCase();
            renderAssets();
            renderWorkOrders();
            renderSummaryStats();
        };

        /* --- FIREBASE LISTENERS --- */

        const listenForAssets = () => {
            if (!window.appState.userId) return;
            const assetRef = collection(db, ASSETS_COLLECTION_PATH);

            onSnapshot(assetRef, (snapshot) => {
                window.appState.allAssets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAssets();
                updateWorkOrderModalAssets(); 
                renderSummaryStats();
                renderChart();
            }, (error) => {
                console.error("Error listening to assets:", error);
            });
        };

        const listenForWorkOrders = () => {
            if (!window.appState.userId) return;
            const woRef = collection(db, WO_COLLECTION_PATH);
            const q = query(woRef);

            onSnapshot(q, (snapshot) => {
                window.appState.allWorkOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderWorkOrders();
                renderSummaryStats();
                renderChart();
            }, (error) => {
                console.error("Error listening to work orders:", error);
            });
        };
        
        /* --- FORM HANDLERS --- */

        window.handleNewAsset = async (event) => {
            event.preventDefault();
            const form = event.target;
            
            const department = form['asset-department'].value;
            const assetName = form['asset-name'].value;

            if (department === 'all' || !department) {
                showNotification("Please select a specific department for the asset.", 'error');
                return;
            }
            
            const assetData = {
                department: department,
                name: assetName,
                location: form['asset-location'].value,
                serial: form['asset-serial'].value || 'N/A',
                description: form['asset-description'].value || '',
                createdAt: new Date(),
                createdBy: window.appState.userId
            };

            try {
                const assetsRef = collection(db, ASSETS_COLLECTION_PATH);
                await addDoc(assetsRef, assetData);
                form.reset();
                toggleModal('new-asset-modal');
                showNotification(`Asset '${assetName}' registered successfully!`, 'success');
            } catch (error) {
                console.error("Error adding asset:", error);
                showNotification("Error registering asset. Check console for details.", 'error');
            }
        };

        window.handleNewWorkOrder = async (event) => {
            event.preventDefault();
            const form = event.target;

            const department = form['wo-department'].value;
            const assetId = form['wo-asset'].value;
            const woTitle = form['wo-title'].value;

            if (department === 'all' || !department) {
                showNotification("Please select a specific department for the work order.", 'error');
                return;
            }

            if (!assetId) {
                showNotification("Please select a related Asset.", 'error');
                return;
            }

            const woData = {
                department: department,
                title: woTitle,
                assetId: assetId,
                priority: form['wo-priority'].value,
                description: form['wo-description'].value || '',
                status: 'Open',
                createdAt: new Date(),
                createdBy: window.appState.userId
            };

            try {
                const woRef = collection(db, WO_COLLECTION_PATH);
                await addDoc(woRef, woData);
                form.reset();
                toggleModal('new-wo-modal');
                showNotification(`Work Order '${woTitle}' created successfully!`, 'success');
            } catch (error) {
                console.error("Error adding work order:", error);
                showNotification("Error creating work order. Check console for details.", 'error');
            }
        };

        window.handleEditWorkOrder = async (event) => {
            event.preventDefault();
            const form = event.target;
            const woId = form['edit-wo-id'].value;

            const updateData = {
                title: form['edit-wo-title'].value,
                priority: form['edit-wo-priority'].value,
                description: form['edit-wo-description'].value || ''
            };

            try {
                const woDocRef = doc(db, WO_COLLECTION_PATH, woId);
                await updateDoc(woDocRef, updateData);
                toggleModal('edit-wo-modal');
                showNotification(`Work Order updated successfully!`, 'success');
            } catch (error) {
                console.error("Error updating work order:", error);
                showNotification("Failed to update work order. Check console.", 'error');
            }
        };

        window.updateWorkOrderStatus = async (woId, newStatus) => {
            try {
                const woDocRef = doc(db, WO_COLLECTION_PATH, woId);
                const updateData = {
                    status: newStatus,
                };
                if (newStatus === 'Completed') {
                    updateData.completedAt = new Date();
                    showNotification(`Work Order ${woId.substring(0, 8)} marked as completed.`, 'success');
                } else if (newStatus === 'In Progress') {
                    showNotification(`Work Order ${woId.substring(0, 8)} started!`, 'info');
                }

                await updateDoc(woDocRef, updateData);
            } catch (error) {
                console.error("Error updating work order status:", error);
                showNotification("Failed to update status. Check console.", 'error');
            }
        };
        
        /* --- UI POPULATION FUNCTIONS --- */
        
        const populateDepartmentDropdowns = () => {
            const filterEl = document.getElementById('department-filter');
            const assetDeptEl = document.getElementById('asset-department');
            const woDeptEl = document.getElementById('wo-department');
            
            const populateSelect = (selectEl, includeAll = true) => {
                selectEl.innerHTML = '';
                if (!includeAll) {
                    selectEl.innerHTML = `<option value="" disabled selected>Select a Department</option>`;
                }
                
                window.appState.departments.forEach(dept => {
                    if (dept.id === 'all' && !includeAll) return;
                    
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name;
                    selectEl.appendChild(option);
                });
            };

            populateSelect(filterEl, true); 
            populateSelect(assetDeptEl, false);
            populateSelect(woDeptEl, false);
            
            woDeptEl.addEventListener('change', updateWorkOrderModalAssets);
        };

        /* --- INITIALIZATION --- */

        const initApp = async () => {
            populateDepartmentDropdowns();
            
            try {
                let user;
                if (initialAuthToken) {
                    const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                    user = userCredential.user;
                } else {
                    const userCredential = await signInAnonymously(auth);
                    user = userCredential.user;
                }
                
                window.appState.userId = user.uid;
                document.getElementById('user-id-display').textContent = user.uid;
                
                listenForAssets();
                listenForWorkOrders();

            } catch (error) {
                console.error("Firebase Authentication/Initialization Error:", error);
                document.getElementById('user-id-display').textContent = 'AUTH ERROR';
                showNotification("Authentication failed. Data will not sync.", 'error');
            }
            
            lucide.createIcons();

            // Dark Mode Toggle
            const toggleButton = document.getElementById('dark-mode-toggle');
            toggleButton.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                toggleButton.innerHTML = `<i data-lucide="${isDark ? 'sun' : 'moon'}" class="w-5 h-5 inline-block mr-1"></i> Toggle ${isDark ? 'Light' : 'Dark'} Mode`;
                lucide.createIcons();
                renderChart(); // Re-render chart for color updates if needed
            });
        };

        window.onload = initApp;
    </script>
</body>
</html>
```
