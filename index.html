<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCC CMMS Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for better aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        .scroll-area {
            max-height: 400px;
            overflow-y: auto;
        }
        .status-badge {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        /* Custom scrollbar for aesthetics */
        .scroll-area::-webkit-scrollbar { width: 6px; }
        .scroll-area::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .scroll-area::-webkit-scrollbar-track { background: #f1f5f9; }
    </style>
</head>
<body class="p-4 md:p-8">
    
    <!-- Tailwind JIT Fix: Explicitly include classes used dynamically -->
    <div class="hidden">
        <span class="border-indigo-500 text-indigo-400"></span>
        <span class="border-red-500 text-red-400"></span>
        <span class="border-green-500 text-green-400"></span>
    </div>

    <header class="mb-8">
        <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">BCC CMMS Dashboard</h1>
        <p class="text-gray-500">Manage assets and streamline maintenance operations across all departments.</p>
        <p class="mt-4 text-sm text-gray-600 p-2 bg-indigo-100 rounded-lg">
            User ID (for collaboration): <span id="user-id-display" class="font-mono font-semibold text-indigo-800">Authenticating...</span>
        </p>
    </header>
    
    <!-- Notification Area -->
    <div id="notification-area" class="fixed top-4 right-4 z-50 space-y-2">
        <!-- Notifications will appear here -->
    </div>

    <!-- Department Filter -->
    <div class="mb-8 p-4 bg-white rounded-xl shadow-lg flex flex-col md:flex-row items-start md:items-center space-y-3 md:space-y-0 md:space-x-4">
        <label for="department-filter" class="font-semibold text-gray-700 flex items-center">
            <i data-lucide="building-2" class="w-5 h-5 mr-2 text-indigo-500"></i>
            Filter by Department:
        </label>
        <select id="department-filter" onchange="changeDepartment(this.value)" class="flex-grow max-w-sm border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
            <!-- Options filled by JS -->
        </select>
    </div>
    
    <!-- STATS ROW (New Feature) -->
    <div id="stats-row" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Stats will be dynamically inserted here by JS -->
    </div>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- WORK ORDERS Section -->
        <section class="lg:col-span-2 card p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i data-lucide="wrench" class="w-6 h-6 mr-2 text-indigo-500"></i>
                Active Work Orders
            </h2>
            <div id="work-orders-list" class="scroll-area divide-y divide-gray-100">
                <!-- Work Orders will be dynamically inserted here -->
                <p class="p-4 text-gray-500 text-center" id="wo-placeholder">Loading work orders...</p>
            </div>

            <!-- New Work Order Form -->
            <button onclick="toggleModal('new-wo-modal')" class="mt-6 w-full py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150">
                <i data-lucide="plus" class="w-5 h-5 inline-block mr-1"></i>
                Create New Work Order
            </button>
        </section>

        <!-- ASSETS Section -->
        <section class="card p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i data-lucide="hard-hat" class="w-6 h-6 mr-2 text-indigo-500"></i>
                Registered Assets
            </h2>
            <div id="assets-list" class="scroll-area divide-y divide-gray-100">
                <!-- Assets will be dynamically inserted here -->
                <p class="p-4 text-gray-500 text-center" id="asset-placeholder">Loading assets...</p>
            </div>

            <!-- New Asset Form -->
            <button onclick="toggleModal('new-asset-modal')" class="mt-6 w-full py-2 px-4 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150">
                <i data-lucide="factory" class="w-5 h-5 inline-block mr-1"></i>
                Add New Asset
            </button>
        </section>
    </main>

    <!-- Modal for New Work Order -->
    <div id="new-wo-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl w-full max-w-lg card">
            <h3 class="text-xl font-bold mb-4">Create Work Order</h3>
            <form id="new-wo-form" onsubmit="handleNewWorkOrder(event)">
                 <div class="mb-4">
                    <label for="wo-department" class="block text-sm font-medium text-gray-700">Department</label>
                    <select id="wo-department" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <!-- Options filled by JS -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="wo-title" class="block text-sm font-medium text-gray-700">Title</label>
                    <input type="text" id="wo-title" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-4">
                    <label for="wo-asset" class="block text-sm font-medium text-gray-700">Related Asset</label>
                    <select id="wo-asset" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Select an Asset</option>
                        <!-- Options filled by JS, filtered by selected department -->
                    </select>
                </div>
                 <div class="mb-4">
                    <label for="wo-priority" class="block text-sm font-medium text-gray-700">Priority</label>
                    <select id="wo-priority" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="High">High</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="toggleModal('new-wo-modal')" class="py-2 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">Cancel</button>
                    <button type="submit" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">Create Work Order</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for New Asset -->
    <div id="new-asset-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl w-full max-w-lg card">
            <h3 class="text-xl font-bold mb-4">Register New Asset</h3>
            <form id="new-asset-form" onsubmit="handleNewAsset(event)">
                 <div class="mb-4">
                    <label for="asset-department" class="block text-sm font-medium text-gray-700">Department</label>
                    <select id="asset-department" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500">
                        <!-- Options filled by JS -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="asset-name" class="block text-sm font-medium text-gray-700">Asset Name</label>
                    <input type="text" id="asset-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="mb-4">
                    <label for="asset-location" class="block text-sm font-medium text-gray-700">Location</label>
                    <input type="text" id="asset-location" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="mb-4">
                    <label for="asset-serial" class="block text-sm font-medium text-gray-700">Serial/Model</label>
                    <input type="text" id="asset-serial" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="toggleModal('new-asset-modal')" class="py-2 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">Cancel</button>
                    <button type="submit" class="py-2 px-4 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">Register Asset</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-cmms-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Base path for public, collaborative data
        const BASE_PUBLIC_PATH = `/artifacts/${appId}/public/data`;
        const ASSETS_COLLECTION_PATH = `${BASE_PUBLIC_PATH}/cmms_assets`;
        const WO_COLLECTION_PATH = `${BASE_PUBLIC_PATH}/cmms_work_orders`;

        // Departments list for BCC
        const DEPARTMENTS = [
            { id: 'all', name: 'All Departments' },
            { id: 'orphanage', name: '1) Orphanage' },
            { id: 'old_age', name: '2) Old Age Home' },
            { id: 'mental_home', name: '3) Mental Home' },
            { id: 'hospice', name: '4) Hospice' },
            { id: 'bci_school', name: '5) BCI School' }
        ];

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Use a global variable to store state and references
        window.appState = {
            db: db,
            auth: auth,
            userId: null,
            // Store all fetched assets and work orders for client-side filtering
            allAssets: [], 
            allWorkOrders: [],
            currentDepartment: 'all', // New state property
            departments: DEPARTMENTS,
        };

        // Set log level to Debug for visibility in console
        setLogLevel('debug');

        /* --- UTILITY FUNCTIONS --- */

        /**
         * Shows a transient notification message.
         * @param {string} message The message to display.
         * @param {string} type 'success', 'error', or 'info'.
         */
        const showNotification = (message, type = 'info') => {
            const notificationArea = document.getElementById('notification-area');
            let colorClass, icon;

            switch (type) {
                case 'success':
                    colorClass = 'bg-green-500 border-green-700';
                    icon = 'check-circle';
                    break;
                case 'error':
                    colorClass = 'bg-red-500 border-red-700';
                    icon = 'alert-triangle';
                    break;
                case 'info':
                default:
                    colorClass = 'bg-blue-500 border-blue-700';
                    icon = 'info';
                    break;
            }

            const notification = document.createElement('div');
            notification.className = `p-4 rounded-lg shadow-xl text-white border-b-4 ${colorClass} transition duration-500 transform translate-x-0`;
            notification.innerHTML = `<div class="flex items-center">
                <i data-lucide="${icon}" class="w-5 h-5 mr-2"></i>
                <span>${message}</span>
            </div>`;
            
            notificationArea.appendChild(notification);
            lucide.createIcons(); // Re-render icon

            // Automatically remove notification after 5 seconds
            setTimeout(() => {
                notification.classList.add('opacity-0');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 5000);
        };


        window.toggleModal = (id) => {
            const modal = document.getElementById(id);
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                // Set the department dropdown in the modal to the current filter if applicable
                const currentDept = window.appState.currentDepartment;
                if (currentDept !== 'all') {
                    if (id === 'new-wo-modal') {
                         const deptEl = document.getElementById('wo-department');
                         if (deptEl) deptEl.value = currentDept;
                    }
                    if (id === 'new-asset-modal') {
                         const deptEl = document.getElementById('asset-department');
                         if (deptEl) deptEl.value = currentDept;
                    }
                }
                updateWorkOrderModalAssets();
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        };

        const formatTimestamp = (timestamp) => {
            if (!timestamp) return 'N/A';
            // Check if timestamp is a Firebase Timestamp object before calling toDate()
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        };

        const getStatusBadge = (status) => {
            switch (status) {
                case 'Open': return `<span class="status-badge bg-red-100 text-red-700">Open</span>`;
                case 'In Progress': return `<span class="status-badge bg-yellow-100 text-yellow-700">In Progress</span>`;
                case 'Completed': return `<span class="status-badge bg-green-100 text-green-700">Completed</span>`;
                default: return `<span class="status-badge bg-gray-100 text-gray-700">${status}</span>`;
            }
        };

        /* --- DATA FILTERING & RENDERING --- */
        
        // New function to render the high-level dashboard statistics
        const renderSummaryStats = () => {
            const statsRowEl = document.getElementById('stats-row');
            if (!statsRowEl) return;

            // 1. Filter data based on current department filter
            const filteredAssets = window.appState.allAssets.filter(asset => 
                window.appState.currentDepartment === 'all' || asset.department === window.appState.currentDepartment
            );
            
            const filteredWOs = window.appState.allWorkOrders.filter(wo => 
                window.appState.currentDepartment === 'all' || wo.department === window.appState.currentDepartment
            );
            
            // 2. Calculate metrics
            const activeWOs = filteredWOs.filter(wo => wo.status !== 'Completed');
            const completedWOs = filteredWOs.filter(wo => wo.status === 'Completed');

            const stats = [
                { title: "Total Assets", count: filteredAssets.length, icon: "hard-hat", color: "indigo" },
                { title: "Active Work Orders", count: activeWOs.length, icon: "wrench", color: "red" },
                { title: "Completed (Lifetime)", count: completedWOs.length, icon: "check-circle", color: "green" },
            ];

            // 3. Render HTML
            statsRowEl.innerHTML = stats.map(stat => `
                <div class="card p-5 border-l-4 border-${stat.color}-500 flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">${stat.title}</p>
                        <p class="text-3xl font-bold text-gray-900">${stat.count}</p>
                    </div>
                    <i data-lucide="${stat.icon}" class="w-8 h-8 text-${stat.color}-400"></i>
                </div>
            `).join('');
            
            // Re-render lucide icons for the newly added HTML
            lucide.createIcons(); 
        };

        // Filters and renders the assets based on the currentDepartment
        const renderAssets = () => {
            const listEl = document.getElementById('assets-list');
            listEl.innerHTML = '';
            
            const filteredAssets = window.appState.allAssets.filter(asset => 
                window.appState.currentDepartment === 'all' || asset.department === window.appState.currentDepartment
            ).sort((a, b) => a.name.localeCompare(b.name)); // Sort assets alphabetically

            if (filteredAssets.length === 0) {
                listEl.innerHTML = `<p class="p-4 text-gray-500 text-center">No assets registered in the selected department (${DEPARTMENTS.find(d => d.id === window.appState.currentDepartment)?.name || 'Unknown'}).</p>`;
                renderSummaryStats(); // Update stats even if list is empty
                return;
            }

            filteredAssets.forEach(asset => {
                const departmentName = DEPARTMENTS.find(d => d.id === asset.department)?.name || 'Unknown';
                const item = document.createElement('div');
                item.className = 'p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center hover:bg-gray-50';
                item.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${asset.name}</p>
                        <p class="text-xs text-indigo-500 font-medium">${departmentName}</p>
                        <p class="text-xs text-gray-500">Location: ${asset.location}</p>
                    </div>
                    <div class="mt-2 sm:mt-0 text-right">
                        <p class="text-xs text-gray-400">Asset ID: ${asset.id.substring(0, 8)}...</p>
                    </div>
                `;
                listEl.appendChild(item);
            });
            renderSummaryStats();
        };

        // Filters and renders the work orders based on the currentDepartment
        const renderWorkOrders = () => {
            const listEl = document.getElementById('work-orders-list');
            listEl.innerHTML = '';
            
            // 1. Filter by Department
            let filteredWO = window.appState.allWorkOrders.filter(wo => 
                window.appState.currentDepartment === 'all' || wo.department === window.appState.currentDepartment
            );
            
            // 2. Filter by Active Status (Open or In Progress) and sort High > Medium > Low
            const activeWO = filteredWO
                .filter(wo => wo.status !== 'Completed')
                .sort((a, b) => {
                    const priorityOrder = { 'High': 3, 'Medium': 2, 'Low': 1 };
                    return priorityOrder[b.priority] - priorityOrder[a.priority];
                });

            if (activeWO.length === 0) {
                listEl.innerHTML = '<p class="p-4 text-gray-500 text-center">No active work orders in this department. Everything looks great!</p>';
                renderSummaryStats(); // Update stats even if list is empty
                return;
            }

            activeWO.forEach(wo => {
                const relatedAsset = window.appState.allAssets.find(a => a.id === wo.assetId);
                const assetName = relatedAsset ? relatedAsset.name : 'Asset Not Found';

                const item = document.createElement('div');
                item.className = 'p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center hover:bg-gray-50';
                item.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800 flex items-center">
                            ${wo.title} 
                            <span class="ml-3 text-xs font-medium ${wo.priority === 'High' ? 'text-red-600' : wo.priority === 'Medium' ? 'text-yellow-600' : 'text-green-600'}">(${wo.priority})</span>
                        </p>
                        <p class="text-sm text-gray-500 mt-1">Asset: ${assetName}</p>
                        <p class="text-xs text-gray-400">Created: ${formatTimestamp(wo.createdAt)}</p>
                    </div>
                    <div class="mt-2 sm:mt-0 flex items-center space-x-2">
                        ${getStatusBadge(wo.status)}
                        ${wo.status !== 'Completed' ? 
                            `<button onclick="updateWorkOrderStatus('${wo.id}', '${wo.status === 'Open' ? 'In Progress' : 'Completed'}')" 
                                class="py-1 px-3 text-xs rounded-full 
                                ${wo.status === 'Open' ? 'bg-yellow-500 hover:bg-yellow-600 text-white' : 'bg-green-500 hover:bg-green-600 text-white'} 
                                transition duration-150">
                                ${wo.status === 'Open' ? 'Start' : 'Complete'}
                            </button>`
                            : ''
                        }
                    </div>
                `;
                listEl.appendChild(item);
            });
            renderSummaryStats();
        };
        
        // Updates the assets dropdown in the New Work Order modal based on the selected department filter
        const updateWorkOrderModalAssets = () => {
            const selectEl = document.getElementById('wo-asset');
            const deptToFilter = document.getElementById('wo-department')?.value || window.appState.currentDepartment;
            
            // Clear existing options
            selectEl.innerHTML = '<option value="" disabled selected>Select an Asset</option>';

            const assetsForDropdown = window.appState.allAssets.filter(asset => 
                deptToFilter === 'all' || asset.department === deptToFilter
            );
            
            if (assetsForDropdown.length === 0) {
                 selectEl.innerHTML += `<option value="" disabled>No Assets in this Department</option>`;
            } else {
                 assetsForDropdown.forEach(asset => {
                    const option = document.createElement('option');
                    option.value = asset.id;
                    option.textContent = `${asset.name} (${asset.location})`;
                    selectEl.appendChild(option);
                });
            }
        };

        // Function called when the main department filter changes
        window.changeDepartment = (newDeptId) => {
            window.appState.currentDepartment = newDeptId;
            renderAssets();
            renderWorkOrders();
            renderSummaryStats();
        };
        
        /* --- FIREBASE LISTENERS --- */

        const listenForAssets = () => {
            if (!window.appState.userId) return;
            // Fetch from shared public collection using the full path
            const assetRef = collection(db, ASSETS_COLLECTION_PATH);

            onSnapshot(assetRef, (snapshot) => {
                window.appState.allAssets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAssets();
                updateWorkOrderModalAssets(); 
            }, (error) => {
                console.error("Error listening to assets:", error);
            });
        };

        const listenForWorkOrders = () => {
            if (!window.appState.userId) return;
            // Fetch from shared public collection using the full path
            const woRef = collection(db, WO_COLLECTION_PATH);
            const q = query(woRef);

            onSnapshot(q, (snapshot) => {
                window.appState.allWorkOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderWorkOrders();
            }, (error) => {
                console.error("Error listening to work orders:", error);
            });
        };
        
        /* --- FORM HANDLERS --- */

        window.handleNewAsset = async (event) => {
            event.preventDefault();
            const form = event.target;
            
            const department = form['asset-department'].value;
            const assetName = form['asset-name'].value;

            if (department === 'all' || !department) {
                showNotification("Please select a specific department for the asset.", 'error');
                return;
            }
            
            const assetData = {
                department: department,
                name: assetName,
                location: form['asset-location'].value,
                serial: form['asset-serial'].value || 'N/A', // Allow serial to be optional
                createdAt: new Date(),
                createdBy: window.appState.userId
            };

            try {
                const assetsRef = collection(db, ASSETS_COLLECTION_PATH);
                await addDoc(assetsRef, assetData);
                form.reset();
                toggleModal('new-asset-modal');
                showNotification(`Asset '${assetName}' registered successfully!`, 'success');
            } catch (error) {
                console.error("Error adding asset:", error);
                showNotification("Error registering asset. Check console for details.", 'error');
            }
        };

        window.handleNewWorkOrder = async (event) => {
            event.preventDefault();
            const form = event.target;

            const department = form['wo-department'].value;
            const assetId = form['wo-asset'].value;
            const woTitle = form['wo-title'].value;

            if (department === 'all' || !department) {
                showNotification("Please select a specific department for the work order.", 'error');
                return;
            }

            if (!assetId) {
                showNotification("Please select a related Asset.", 'error');
                return;
            }

            const woData = {
                department: department,
                title: woTitle,
                assetId: assetId,
                priority: form['wo-priority'].value,
                status: 'Open',
                createdAt: new Date(),
                createdBy: window.appState.userId
            };

            try {
                const woRef = collection(db, WO_COLLECTION_PATH);
                await addDoc(woRef, woData);
                form.reset();
                toggleModal('new-wo-modal');
                showNotification(`Work Order '${woTitle}' created successfully!`, 'success');
            } catch (error) {
                console.error("Error adding work order:", error);
                showNotification("Error creating work order. Check console for details.", 'error');
            }
        };

        window.updateWorkOrderStatus = async (woId, newStatus) => {
            try {
                // Get the document reference using the full path
                const woDocRef = doc(db, WO_COLLECTION_PATH, woId);
                const updateData = {
                    status: newStatus,
                };
                if (newStatus === 'Completed') {
                    updateData.completedAt = new Date();
                    showNotification(`Work Order ${woId.substring(0, 8)} marked as completed.`, 'success');
                } else if (newStatus === 'In Progress') {
                    showNotification(`Work Order ${woId.substring(0, 8)} started!`, 'info');
                }

                await updateDoc(woDocRef, updateData);
            } catch (error) {
                console.error("Error updating work order status:", error);
                showNotification("Failed to update status. Check console.", 'error');
            }
        };
        
        /* --- UI POPULATION FUNCTIONS --- */
        
        const populateDepartmentDropdowns = () => {
            const filterEl = document.getElementById('department-filter');
            const assetDeptEl = document.getElementById('asset-department');
            const woDeptEl = document.getElementById('wo-department');
            
            // Function to populate a single select element
            const populateSelect = (selectEl, includeAll = true) => {
                selectEl.innerHTML = '';
                if (!includeAll) {
                    selectEl.innerHTML = `<option value="" disabled selected>Select a Department</option>`;
                }
                
                window.appState.departments.forEach(dept => {
                    // Skip 'All Departments' for creation modals
                    if (dept.id === 'all' && !includeAll) return;
                    
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name;
                    selectEl.appendChild(option);
                });
            };

            // Populate Filter (includes 'All Departments')
            populateSelect(filterEl, true); 
            
            // Populate Modals (does NOT include 'All Departments')
            populateSelect(assetDeptEl, false);
            populateSelect(woDeptEl, false);
            
             // Attach event listener for work order asset filtering
            woDeptEl.addEventListener('change', updateWorkOrderModalAssets);
        };


        /* --- INITIALIZATION --- */

        const initApp = async () => {
            populateDepartmentDropdowns();
            
            try {
                let user;
                if (initialAuthToken) {
                    const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                    user = userCredential.user;
                } else {
                    const userCredential = await signInAnonymously(auth);
                    user = userCredential.user;
                }
                
                window.appState.userId = user.uid;
                document.getElementById('user-id-display').textContent = user.uid;
                
                // Start listeners once authenticated (will now fetch collaborative data)
                listenForAssets();
                listenForWorkOrders();

            } catch (error) {
                console.error("Firebase Authentication/Initialization Error:", error);
                document.getElementById('user-id-display').textContent = 'AUTH ERROR';
                showNotification("Authentication failed. Data will not sync.", 'error');
            }
            
            // Render lucide icons after initialization is complete
            lucide.createIcons();
        };

        // Start the application after the window loads
        window.onload = initApp;
    </script>
</body>
</html>
